<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netlify CORS Example</title>
  <!-- <script type="module" src="./netlify/functions/proxy.js"></script> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>

  <h1>Netlify CORS Example</h1>

  <div>
    <label for="startDate">Start Date:</label>
    <input type="text" id="startDate" data-input>
  </div>
  
  <div>
    <label for="endDate">End Date:</label>
    <input type="text" id="endDate" data-input>
  </div>

  <div id="tableContainer"></div>

  <script>
    const currentDate = new Date();
    const firstDayOfCurrentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
    const lastDayOfCurrentMonth = new Date(nextMonth - 1);

    let from = firstDayOfCurrentMonth
    let to = lastDayOfCurrentMonth

    document.addEventListener('DOMContentLoaded', function () {
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');

      const startDatePicker = flatpickr(startDateInput, {
        dateFormat: 'Y-m-d',
        onChange: function (selectedDates, dateStr) {
          from = new Date(dateStr);
          getDataAndRenderTable();
        }
      });

      const endDatePicker = flatpickr(endDateInput, {
        dateFormat: 'Y-m-d',
        onChange: function (selectedDates, dateStr) {
          to = new Date(dateStr);
          getDataAndRenderTable();
        }
      });

      startDatePicker.setDate(from);
      endDatePicker.setDate(to);
    });
  </script>

  <script>
    const USERNAMES = {
            81: "Иванова Анастасия Николаевна",
            82: "Сериков Роман Андреевич",
            89: "Евженко Илья Владимиррович",
            90: "Колесников Егор Сергеевич",
            94: "Иванюченко Дмитрий Юрьевич",
            97: "Бочаров Евгений Дмитриевич",
            102: "Козлов Егор Владимирович",
            107: "Сидорский Глеб Олегович",
            112: "Шерай Андрей Викторович",
            121: "Коровка Анастасия Сергеевна",
            130: "Аккаунт для Джунов",
            131: "Столяров Анатолий Игоревич",
            138: "Попов Дмитрий Николаевич",
            141: "Добряков Павел Александрович",
            143: "Козлов Игорь Владимирович",
            144: "Максим Мурачёв",
            146: "Бурзиев Кирилл Владимирович",
            147: "Козлов Кирилл Владимирович",
            151: "Кухновец Николай Владимирович",
            152: "Леус Константин Владимирович"
          };

    async function getDataAndRenderTable() {
      const tableContainer = document.getElementById('tableContainer');
      tableContainer.innerHTML = '';
      const dataArray = [];
      const activeCompaniesSet = new Set();
      const fetchPromises = [];

       function transformToUserObject(id, responseObject) {
        const template = { 
          "Adcombo": 0,
          "Aff1": 0,
          "AffScale": 0,
          "Affstar": 0,
          "auron.scaleo": 0,
          "cryp.im": 0,
          "dr.cash": 0,
          "dr.cash stolcs81@gmail.com": 0,
          "Everad": 0,
          "INB": 0,
          "KMA Biz": 0,
          "LeadBit": 0,
          "LeadReaktor": 0,
          "LeadRock": 0,
          "LemonAD": 0,
          "LemonAd Vovahom": 0,
          "Lucky2Online": 0,
          "LuckyOnline": 0,
          "M1 Shop": 0,
          "Moonadvert": 0,
          "Offer.store": 0,
          "ProfitPay": 0,
          "RocketProfit": 0,
          "Shakes stolcs81@gmail.com": 0,
          "Shakes.pro": 0,
          "SkyLead": 0,
          "Terra Leads": 0,
        };

        const userObject = { "id": id, "name": USERNAMES[id], ...template};

        for (const key in responseObject) {
            if (responseObject.hasOwnProperty(key)) {
                const companyName = responseObject[key].name;
                const totalAmount = responseObject[key].wm;

                if (!userObject.hasOwnProperty(companyName)) {
                  userObject[companyName] = totalAmount;
                  if (totalAmount !== 0) {
                    console.log(companyName)
                    activeCompaniesSet.add(companyName)
                  }
                } else {
                  userObject[companyName] += totalAmount;
                  if (totalAmount !== 0) {
                    console.log(companyName)
                    activeCompaniesSet.add(companyName);
                  }
                }
            }
        }

        return userObject;
      }

      async function fetchData(userId, from, to) {
        try {
          const response = await fetch(`/api?id=1-c89b95bac18d8810ea68d56a32db1aca&item=comp&user=${userId}&phase=3&from=${from}&to=${to}`);
          const responseObject = await response.json();

          dataArray.push(transformToUserObject(userId, responseObject));
        } catch (error) {
          console.log('Error fetching data:', error);
        }
      }

      for (const id in USERNAMES) {
        fetchPromises.push(fetchData(id, from, to));
      }

      try {
          await Promise.all(fetchPromises);


          const table = document.createElement('table');
          table.setAttribute('border', '1');

          const headerRow = document.createElement('tr');

          function addElement(parentNone, tag, textContent='') {
            const element = document.createElement(tag);
            element.textContent = textContent;
            parentNone.appendChild(element);
          }

          addElement(headerRow,'th','ID')
          addElement(headerRow,'th','Name')
          activeCompaniesSet.forEach(companyName => {
            addElement(headerRow,'th',companyName)
          });

          table.appendChild(headerRow);

          dataArray.forEach(userObject => {
            const dataRow = document.createElement('tr');

            addElement(dataRow, 'td', userObject.id);
            addElement(dataRow, 'td', userObject.name);
            activeCompaniesSet.forEach(companyName => {
              addElement(dataRow, 'td', userObject[companyName]);
            });

            table.appendChild(dataRow);
          });

          tableContainer.appendChild(table);
        } catch (error) {
          console.log('Error fetching data:', error);
        }
      
    }

    document.addEventListener('DOMContentLoaded', async function() {
      getDataAndRenderTable();
    });

  </script>

</body>
</html>